name: Build R Binaries

on:
  push:
    paths:
      - "src/contrib/*.tar.gz"
    branches:
      - main

jobs:
  build:
    name: Build R Binaries
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
    outputs:
      macos_artifact: ${{ steps.upload_macos.outputs.artifact_name }}
      windows_artifact: ${{ steps.upload_windows.outputs.artifact_name }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4.0'

      - name: Install Dependencies
        run: |
          install.packages(c("devtools"))
        shell: Rscript {0}

      - name: Find the Latest Source Package
        id: find_source
        run: |
          latest_pkg <- list.files("src/contrib", pattern = "\\.tar\\.gz$", full.names = TRUE)
          latest_pkg <- latest_pkg[order(file.info(latest_pkg)$mtime, decreasing = TRUE)][1]
          cat(sprintf("SRC_PACKAGE=%s\n", latest_pkg), file = Sys.getenv("GITHUB_ENV"), append = TRUE)
        shell: Rscript {0}

      - name: Build macOS Binary (if on macOS)
        if: matrix.os == 'macos-latest'
        run: |
          R CMD INSTALL --build "${{ env.SRC_PACKAGE }}"
        shell: bash

      - name: Build Windows Binary (if on Windows)
        if: matrix.os == 'windows-latest'
        run: |
          options(noninteractive = TRUE); devtools::build(pkg = "${{ env.SRC_PACKAGE }}", binary = TRUE)
        shell: Rscript {0}

      - name: Upload macOS Binary
        if: matrix.os == 'macos-latest'
        id: upload_macos
        uses: actions/upload-artifact@v4
        with:
          name: macos-binary
          path: "*.tgz"

      - name: Upload Windows Binary
        if: matrix.os == 'windows-latest'
        id: upload_windows
        uses: actions/upload-artifact@v4
        with:
          name: windows-binary
          path: "*.zip"

  push:
    name: Push Binaries to Repository
    runs-on: ubuntu-latest
    needs: build  # Wait until both macOS and Windows jobs complete
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Download macOS Binary
        uses: actions/download-artifact@v4
        with:
          name: macos-binary
          path: bin/macosx/contrib/4.4/

      - name: Download Windows Binary
        uses: actions/download-artifact@v4
        with:
          name: windows-binary
          path: bin/windows/contrib/4.4/

      - name: Update PACKAGES Metadata
        run: |
          Rscript -e "tools::write_PACKAGES('src/contrib', type='source')"
          Rscript -e "tools::write_PACKAGES('bin/windows/contrib/4.4', type='win.binary')"
          Rscript -e "tools::write_PACKAGES('bin/macosx/contrib/4.4', type='mac.binary')"

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Add R package binaries for ${{ env.SRC_PACKAGE }}" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
